#!/bin/zsh

INTERVAL=1
LICHESS_INTERVAL=5

calculate_cpu_usage()
{
    DATAFILE="/tmp/cpu_usage_data"
    RESFILE="/tmp/cpu_usage"

    CPU=($(cat /proc/stat | grep '^cpu ')) # Get the total CPU statistics.
    shift CPU
    IDLE=${CPU[4]}                        # Get the idle CPU time.

    # Calculate the total CPU time.
    TOTAL=0
    for VALUE in "${CPU[@]}"; do
        let "TOTAL=$TOTAL+$VALUE"
    done

    if [ -f $DATAFILE ]; then
        set -- $(cat $DATAFILE)
        # Calculate the CPU usage since we last checked.
        let "DIFF_IDLE=$IDLE-$1"
        let "DIFF_TOTAL=$TOTAL-$2"
        let "DIFF_USAGE=(1000*($DIFF_TOTAL-$DIFF_IDLE)/$DIFF_TOTAL+5)/10"
        echo $DIFF_USAGE > $RESFILE
    fi

    # Remember the total and idle CPU times for the next check.
    echo "$IDLE $TOTAL" > $DATAFILE
}

fetch_lichess_players()
{
    DATAFILE="/tmp/lichess_players"
    echo $(curl -sL http://lichess.org/how-many-players-now) > $DATAFILE
}

while true; do

    sleep $INTERVAL

    calculate_cpu_usage

    [ "$(date +%S)" -eq "0" ] && fetch_lichess_players

    #printf "%s, %s\n" $(cat /tmp/cpu_usage) $(cat /tmp/lichess_players)

done
