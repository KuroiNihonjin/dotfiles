#!/bin/zsh
# 0 black
# 1 red
# 2 green
# 3 yellow
# 4 blue
# 5 pink
# 6 cyan
# 9 orange
# black -> white 8 0 10 11 12 14 7 15

# WEECHAT

if [ -f /tmp/weechat_hotlist ]; then
  hotlist=$(cat /tmp/weechat_hotlist)
  if [ ! -z $hotlist ]; then
    printf "%s " "$hotlist"
  fi
fi

# LICHESS

raw_data=$(cat /tmp/lichess_status)
data=(${(s: :)raw_data})
printf "#[fg=colour10,dim](%d|%d:%d/%d|%s|%s" $data[1] $data[2] $data[3] $data[4] $data[5] $data[6] $loadtime

loadtime=$(cat /tmp/lichess_loadtime)
isinf=$(echo "$loadtime < 0.2" | bc)
if [ $isinf = 0 ]; then
  lltc="bg=colour3 fg=colour0"
else
  lltc="fg=colour11"
fi
printf "##[%s]%s#[fg=colour10,bg=default,dim])#[default] " $lltc $loadtime

# MAIL

syncing=$(pgrep offlineimap | wc -l)
if [ $syncing != 0 ]; then
  mailicon="↻"
else
  mailicon="@"
fi

# args: name, box_dir
show_mail() {
  wcl=$(ls -l $2/new | wc -l)
  nb=$(expr $wcl - 1)
  if [ $syncing != 0 ]; then style="fg=colour12"
  else
    if [ 0 -eq $nb ]; then style="fg=colour10,dim"
    else style="fg=colour7"
    fi
  fi
  printf "#[%s]%s%s(%d)#[default] " $style $mailicon $1 $nb
}
show_mail "perso" "$HOME/.mail/thibault.duplessis.gmail.com/INBOX"
show_mail "jirafe" "$HOME/.mail/thibault.jirafe.com/INBOX"

# BATTERY

infos=$(acpi -b)
percent=$(echo $infos|sed "s/Battery .: [a-z]*, \([0-9]*\)%\(,.*\|$\)/\1/i")
state=$(echo $infos|sed "s/Battery .: \([a-z]*\),.*/\1/i")
if [ "$percent" -lt 5 ]; then modifier="#[bg=colour1,fg=colour15,bright]"
elif [ "$percent" -lt 20 ]; then modifier="#[bg=colour3,fg=colour8,bright]"
elif [ "$percent" -lt 50 ]; then modifier="#[fg=colour3]"
else modifier="#[fg=colour2]"
fi
percentS="$percent%"
case $state in
  "Discharging") sign="|-|" ;;
"Full") sign="⚡"; percentS= ;;
*)
  if [ "$percent" -gt 94 ]; then
    sign="⚡"
    percentS=
  else
    sign="|+|"
    modifier="#[fg=green]"
  fi
  ;;
esac
printf "$modifier%s%s#[default]" "$percentS" "$sign"

# TEMPERATURE

temp_file=/sys/class/hwmon/hwmon0/temp1_input
temperature=$(awk '{printf "%0.f",$1/1000}' "$temp_file")
if [ -n "$temperature" ]; then
  if [ "$temperature" -gt 69 ]; then modifier="#[bg=colour1,fg=colour15,bright]"
  elif [ "$temperature" -gt 62 ]; then modifier="#[fg=colour13,bright]"
  elif [ "$temperature" -gt 54 ]; then modifier="#[fg=colour6]"
  else modifier="#[fg=colour4]"
  fi
  printf " %s%s°#[default]" "$modifier" "$temperature"
fi

# MEMORY

memory=$(free | awk '/buffers\/cache:/ {printf "%.0f", 100*$3/($3 + $4)}')
if [ "$memory" -gt 90 ]; then modifier="#[bg=colour1,fg=colour15,bright]"
elif [ "$memory" -gt 80 ]; then modifier="#[bg=colour3,fg=colour0]"
elif [ "$memory" -gt 70 ]; then modifier="#[fg=colour9]"
else modifier="#[fg=colour2]"
fi
printf " %s%s%%#[default]" "$modifier" "$memory"

# CPU FREQ

if [ -r "/sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq" ]; then
  chart=""
  for i in 0 1 2 3; do
    cpu_file="/sys/devices/system/cpu/cpu$i/cpufreq/scaling_cur_freq"
    cpu=$(awk '{printf "%0.f",$1/100000}' "$cpu_file")
    if [ "$cpu" -lt 13 ]; then symbol="#[fg=colour2]⎯"
    elif [ "$cpu" -lt 15 ]; then symbol="#[fg=colour10]⎯"
    elif [ "$cpu" -lt 17 ]; then symbol="#[fg=colour10]▁"
    elif [ "$cpu" -lt 19 ]; then symbol="#[fg=colour10]▂"
    elif [ "$cpu" -lt 21 ]; then symbol="#[fg=colour10]▃"
    elif [ "$cpu" -lt 23 ]; then symbol="#[fg=colour10]▄"
    elif [ "$cpu" -lt 25 ]; then symbol="#[fg=colour10]▅"
    elif [ "$cpu" -lt 27 ]; then symbol="#[fg=colour10]▆"
    elif [ "$cpu" -lt 29 ]; then symbol="#[fg=colour10]▇"
    else symbol="#[fg=colour12]█"
    fi
    chart="$chart$symbol"
  done
  printf " $chart";
fi

# LOAD AVERAGE

load=$(awk '{print $1}' /proc/loadavg)
printf " %s%.01f#[default]" "#[fg=colour14]" "$load"

# SEPARATOR

#printf " #[fg=magenta]•#[default]"

# FRENCH DATE

#export TZ="Europe/Paris"
printf " #[fg=colour12]⎛$(date +"%a %b %d") $(date +"%H:%M")#[default]"
