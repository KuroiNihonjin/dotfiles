#!/bin/zsh
# 0 black
# 1 red
# 2 green
# 3 yellow
# 4 blue
# 5 pink
# 6 cyan
# 9 orange
# black -> white 8 0 10 11 12 14 7 15 

# WEECHAT

if [ -f /tmp/weechat_hotlist ]; then
    hotlist=$(cat /tmp/weechat_hotlist)
    if [ ! -z $hotlist ]; then
        printf "%s " "$hotlist"
    fi
fi

# MAIL

show_mail() {
  if [ 0 -eq $2 ]; then mfg="colour10, dim"
  else mfg="colour7"
  fi
  printf "#[fg=%s,dim]%s(%d)#[default] " $mfg $1 $2
}

TD_BOX="$HOME/.mail/thibault.duplessis.gmail.com/INBOX"
TD_COUNT=`ls -l $TD_BOX/new | wc -l`
TD_NEW=`expr $TD_COUNT - 1`
show_mail "td" $TD_NEW

# BATTERY

infos=$(acpi -b)
percent=$(echo $infos|sed "s/Battery .: [a-z]*, \([0-9]*\)%\(,.*\|$\)/\1/i")
state=$(echo $infos|sed "s/Battery .: \([a-z]*\),.*/\1/i")
if [ "$percent" -lt 5 ]; then modifier="#[bg=colour1,fg=colour15,bright]"
elif [ "$percent" -lt 20 ]; then modifier="#[bg=colour3,fg=colour8,bright]"
elif [ "$percent" -lt 50 ]; then modifier="#[fg=colour3]"
else modifier="#[fg=colour2]"
fi
percent="$percent%"
case $state in
    "Charging") sign="|+|"; modifier="#[fg=green]" ;;
    "Discharging") sign="|-|" ;;
    "Full") sign="⚡"; percent= ;;
    *) sign="$state" ;;
esac
printf "$modifier%s%s#[default]" "$percent" "$sign"

# TEMPERATURE

input=/sys/class/hwmon/hwmon0/temp1_input
[ -s "$input" ] && temperature=$(awk '{printf "%0.f",$1/1000}' "$input")
if [ -n "$temperature" ]; then
	if [ "$temperature" -gt 69 ]; then modifier="#[bg=colour1,fg=colour15,bright]"
	elif [ "$temperature" -gt 62 ]; then modifier="#[fg=colour13,bright]"
	elif [ "$temperature" -gt 54 ]; then modifier="#[fg=colour6]"
	else modifier="#[fg=colour4]"
	fi
    printf " %s%s°#[default]" "$modifier" "$temperature"
fi

# MEMORY

memory=$(free | awk '/buffers\/cache:/ {printf "%.0f", 100*$3/($3 + $4)}')
if [ "$memory" -gt 90 ]; then modifier="#[bg=colour1,fg=colour15,bright]"
elif [ "$memory" -gt 80 ]; then modifier="#[bg=colour3,fg=colour0]"
elif [ "$memory" -gt 70 ]; then modifier="#[fg=colour9]"
else modifier="#[fg=colour2]"
fi
printf " %s%s%%#[default]" "$modifier" "$memory"

# CPU BAR

nbcores=4
divisor=2
usage=$(cat /tmp/cpu_usage)
(( usage = usage * nbcores / divisor ))
(( index = usage / 4 ))
[ $index -gt 24 ] && index=24
bar="                        "
for bari in $(seq $index); do
    bar[$bari]="|"
done
if [ "$usage" -gt 50 ]; then modifier="#[fg=colour1]"
#elif [ "$usage" -gt 50 ]; then modifier="#[fg=yellow,bright]"
#elif [ "$usage" -gt 25 ]; then modifier="#[fg=white, bright]"
else modifier="#[fg=colour14]"
fi
printf " %s[%s#[default]" "$modifier" "$bar"

# CPU FREQ

if [ -r "/sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq" ]; then
  read hz < /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
  freq=$(print "scale = 1; $hz / 1000000" | bc)
  printf " #[fg=colour3]%s" "$freq"; 
fi
printf "#[fg=colour14]]#[default]"

# LOAD AVERAGE

load=$(awk '{print $1}' /proc/loadavg)
printf " %s%.01f#[default]" "#[fg=colour14]" "$load"

# SEPARATOR

#printf " #[fg=magenta]•#[default]"

# LICHESS PLAYERS

raw_data=$(cat /tmp/lichess_status)
data=(${(s: :)raw_data})
printf " #[fg=colour10,dim](%d|%d+%d:%d|%s)#[default]" $data[1] $data[2] $data[4] $data[3] $data[5]

# FRENCH DATE

#export TZ="Europe/Paris"
printf " #[fg=colour12]$(date +"%a %b %d") $(date +"%H:%M")#[default]"
